import React, { useEffect, useState } from 'react';
import { api } from '../api/api';
import DashboardLayout from '../components/DashboardLayout';
import '../styles/modal.css';

export default function Students() {
  const [students, setStudents] = useState([]);
  const [error, setError] = useState('');
  const [success, setSuccess] = useState('');
  const [loading, setLoading] = useState(true);
  const [showModal, setShowModal] = useState(false);
  const [departments, setDepartments] = useState([]);
  const [programs, setPrograms] = useState([]);
  const [parents, setParents] = useState([]);
  const [batches, setBatches] = useState([]);
  const [statuses, setStatuses] = useState([]);
  const [scholarships, setScholarships] = useState([]);
  const [provinces, setProvinces] = useState([]);
  const [districts, setDistricts] = useState([]);
  const [communes, setCommunes] = useState([]);
  const [villages, setVillages] = useState([]);
  const [form, setForm] = useState({
    username: '',
    email: '',
    password: '',
    student_code: '',
    std_eng_name: '',
    std_khmer_name: '',
    gender: '0',
    dob: '',
    phone: '',
    department_id: '',
    program_id: '',
    batch_id: '',
    nationality: 'Cambodian',
    race: 'Khmer',
    from_high_school: '',
    marital_status: '0',
    parent_id: '',
    province_no: '',
    district_no: '',
    commune_no: '',
    village_no: '',
    std_status_id: '',
    schoolarship_id: '',
    description: ''
  });

  useEffect(() => {
    loadData();
  }, [showModal]);

  const loadData = async () => {
    try {
      const studentsData = await api.getStudents();
      setStudents(studentsData);
      
      // Load dropdown data when modal opens
      if (showModal) {
        const [deptData, progData, parentData, provinceData] = await Promise.all([
          api.getDepartments(),
          api.getPrograms(),
          api.getParents(),
          api.getProvinces()
        ]);
        setDepartments(deptData);
        setPrograms(progData);
        setParents(parentData);
        setProvinces(provinceData);
        // Set mock data for now
        setBatches([{ id: 1, name: 'Batch 2024' }, { id: 2, name: 'Batch 2025' }]);
        setStatuses([{ id: 1, name: 'Active' }, { id: 2, name: 'Inactive' }, { id: 3, name: 'Graduated' }]);
        setScholarships([{ id: 1, name: 'Full Scholarship' }, { id: 2, name: 'Partial Scholarship' }]);
      }
    } catch (err) {
      setError(err.message);
    } finally {
      setLoading(false);
    }
  };

  const handleProvinceChange = async (e) => {
    const provinceId = e.target.value;
    setForm({ ...form, province_no: provinceId, district_no: '', commune_no: '', village_no: '' });
    setDistricts([]);
    setCommunes([]);
    setVillages([]);
    
    if (provinceId) {
      try {
        const districtData = await api.getDistricts(provinceId);
        setDistricts(districtData);
      } catch (err) {
        setError(err.message);
      }
    }
  };

  const handleDistrictChange = async (e) => {
    const districtId = e.target.value;
    setForm({ ...form, district_no: districtId, commune_no: '', village_no: '' });
    setCommunes([]);
    setVillages([]);
    
    if (districtId) {
      try {
        const communeData = await api.getCommunes(districtId);
        setCommunes(communeData);
      } catch (err) {
        setError(err.message);
      }
    }
  };

  const handleCommuneChange = async (e) => {
    const communeId = e.target.value;
    setForm({ ...form, commune_no: communeId, village_no: '' });
    setVillages([]);
    
    if (communeId) {
      try {
        const villageData = await api.getVillages(communeId);
        setVillages(villageData);
      } catch (err) {
        setError(err.message);
      }
    }
  };

  const handleChange = (e) => {
    setForm({ ...form, [e.target.name]: e.target.value });
  };

  const handleSubmit = async (e) => {
    e.preventDefault();
    setError('');
    setSuccess('');
    
    try {
      const newStudent = await api.createStudent(form);
      setStudents([...students, newStudent]);
      setShowModal(false);
      setForm({
        username: '',
        email: '',
        password: '',
        student_code: '',
        std_eng_name: '',
        std_khmer_name: '',
        gender: '0',
        dob: '',
        phone: '',
        department_id: '',
        program_id: '',
        batch_id: '',
        nationality: 'Cambodian',
        race: 'Khmer',
        from_high_school: '',
        marital_status: '0',
        parent_id: '',
        province_no: '',
        district_no: '',
        commune_no: '',
        village_no: '',
        std_status_id: '',
        schoolarship_id: '',
        description: ''
      });
      setSuccess('Student created successfully!');
      setTimeout(() => setSuccess(''), 3000);
    } catch (err) {
      setError(err.message);
    }
  };

  if (loading) return <DashboardLayout><div>Loading students...</div></DashboardLayout>;

  return (
    <DashboardLayout>
      <div className="content-header" style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
        <div>
          <h1 className="content-title">Students</h1>
          <p className="content-subtitle">Manage and view all student records</p>
        </div>
        <button 
          onClick={() => setShowModal(true)}
          style={{ 
            background: '#4f46e5', 
            color: '#fff', 
            padding: '10px 20px', 
            border: 'none', 
            borderRadius: 6, 
            cursor: 'pointer', 
            fontWeight: 600,
            fontSize: '0.95rem'
          }}
        >
          + Add Student
        </button>
      </div>
      {error && <div style={{ color: '#ef4444', padding: 12, background: '#fee', borderRadius: 8, marginBottom: 16 }}>{error}</div>}
      {success && <div style={{ color: '#047857', padding: 12, background: '#d1fae5', borderRadius: 8, marginBottom: 16 }}>{success}</div>}
      
      {/* Add Student Modal */}
      {showModal && (
        <div className="modal-overlay">
          <div className="modal-container">
            {/* Header */}
            <div className="modal-header">
              <h2>Add New Student</h2>
              <p>Fill in all required information below</p>
            </div>
            
            {/* Form Content */}
            <div className="modal-body">
              <form onSubmit={handleSubmit} id="studentForm">
                {/* Account Information */}
                <div className="form-section">
                  <h3 className="section-title">
                    <span className="section-icon">üîê</span>
                    Account Information
                  </h3>
                  <div className="form-grid">
                    <div className="form-field">
                      <label className="form-label">Username <span className="required">*</span></label>
                      <input name="username" value={form.username} onChange={handleChange} required className="form-input" />
                    </div>
                    <div className="form-field">
                      <label className="form-label">Email <span className="required">*</span></label>
                      <input type="email" name="email" value={form.email} onChange={handleChange} required className="form-input" />
                    </div>
                    <div className="form-field">
                      <label className="form-label">Password <span className="required">*</span></label>
                      <input type="password" name="password" value={form.password} onChange={handleChange} required className="form-input" />
                    </div>
                  </div>
                </div>

                {/* Personal Information */}
                <div style={{ marginBottom: 32 }}>
                  <h3 style={{ fontSize: '1.1rem', fontWeight: 600, color: '#1f2937', marginBottom: 16, paddingBottom: 8, borderBottom: '2px solid #4f46e5' }}>
                    üë§ Personal Information
                  </h3>
                  <div style={{ display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: 16 }}>
                    <div>
                      <label style={{ display: 'block', marginBottom: 6, fontWeight: 600, fontSize: '0.875rem', color: '#374151' }}>Student Code *</label>
                      <input name="student_code" value={form.student_code} onChange={handleChange} required style={{ width: '100%', padding: '10px 14px', border: '2px solid #e5e7eb', borderRadius: 8, fontSize: '0.95rem', transition: 'all 0.2s' }} onFocus={(e) => e.target.style.borderColor = '#4f46e5'} onBlur={(e) => e.target.style.borderColor = '#e5e7eb'} />
                    </div>
                    <div>
                      <label style={{ display: 'block', marginBottom: 6, fontWeight: 600, fontSize: '0.875rem', color: '#374151' }}>English Name *</label>
                      <input name="std_eng_name" value={form.std_eng_name} onChange={handleChange} required style={{ width: '100%', padding: '10px 14px', border: '2px solid #e5e7eb', borderRadius: 8, fontSize: '0.95rem', transition: 'all 0.2s' }} onFocus={(e) => e.target.style.borderColor = '#4f46e5'} onBlur={(e) => e.target.style.borderColor = '#e5e7eb'} />
                    </div>
                    <div>
                      <label style={{ display: 'block', marginBottom: 6, fontWeight: 600, fontSize: '0.875rem', color: '#374151' }}>Khmer Name *</label>
                      <input name="std_khmer_name" value={form.std_khmer_name} onChange={handleChange} required style={{ width: '100%', padding: '10px 14px', border: '2px solid #e5e7eb', borderRadius: 8, fontSize: '0.95rem', transition: 'all 0.2s' }} onFocus={(e) => e.target.style.borderColor = '#4f46e5'} onBlur={(e) => e.target.style.borderColor = '#e5e7eb'} />
                    </div>
                    <div>
                      <label style={{ display: 'block', marginBottom: 6, fontWeight: 600, fontSize: '0.875rem', color: '#374151' }}>Gender *</label>
                      <select name="gender" value={form.gender} onChange={handleChange} required style={{ width: '100%', padding: '10px 14px', border: '2px solid #e5e7eb', borderRadius: 8, fontSize: '0.95rem', background: 'white' }}>
                        <option value="0">Male</option>
                        <option value="1">Female</option>
                      </select>
                    </div>
                    <div>
                      <label style={{ display: 'block', marginBottom: 6, fontWeight: 600, fontSize: '0.875rem', color: '#374151' }}>Date of Birth *</label>
                      <input type="date" name="dob" value={form.dob} onChange={handleChange} required style={{ width: '100%', padding: '10px 14px', border: '2px solid #e5e7eb', borderRadius: 8, fontSize: '0.95rem' }} />
                    </div>
                    <div>
                      <label style={{ display: 'block', marginBottom: 6, fontWeight: 600, fontSize: '0.875rem', color: '#374151' }}>Phone *</label>
                      <input type="tel" name="phone" value={form.phone} onChange={handleChange} required style={{ width: '100%', padding: '10px 14px', border: '2px solid #e5e7eb', borderRadius: 8, fontSize: '0.95rem' }} />
                    </div>
                    <div>
                      <label style={{ display: 'block', marginBottom: 6, fontWeight: 600, fontSize: '0.875rem', color: '#374151' }}>Nationality *</label>
                      <input name="nationality" value={form.nationality} onChange={handleChange} required style={{ width: '100%', padding: '10px 14px', border: '2px solid #e5e7eb', borderRadius: 8, fontSize: '0.95rem' }} />
                    </div>
                    <div>
                      <label style={{ display: 'block', marginBottom: 6, fontWeight: 600, fontSize: '0.875rem', color: '#374151' }}>Race *</label>
                      <input name="race" value={form.race} onChange={handleChange} required style={{ width: '100%', padding: '10px 14px', border: '2px solid #e5e7eb', borderRadius: 8, fontSize: '0.95rem' }} />
                    </div>
                    <div>
                      <label style={{ display: 'block', marginBottom: 6, fontWeight: 600, fontSize: '0.875rem', color: '#374151' }}>Marital Status *</label>
                      <select name="marital_status" value={form.marital_status} onChange={handleChange} required style={{ width: '100%', padding: '10px 14px', border: '2px solid #e5e7eb', borderRadius: 8, fontSize: '0.95rem', background: 'white' }}>
                        <option value="0">Single</option>
                        <option value="1">Married</option>
                      </select>
                    </div>
                  </div>
                </div>

                {/* Academic Information */}
                <div style={{ marginBottom: 32 }}>
                  <h3 style={{ fontSize: '1.1rem', fontWeight: 600, color: '#1f2937', marginBottom: 16, paddingBottom: 8, borderBottom: '2px solid #4f46e5' }}>
                    üéì Academic Information
                  </h3>
                  <div style={{ display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: 16 }}>
                    <div>
                      <label style={{ display: 'block', marginBottom: 6, fontWeight: 600, fontSize: '0.875rem', color: '#374151' }}>Department *</label>
                      <select name="department_id" value={form.department_id} onChange={handleChange} required style={{ width: '100%', padding: '10px 14px', border: '2px solid #e5e7eb', borderRadius: 8, fontSize: '0.95rem', background: 'white' }}>
                        <option value="">Select Department</option>
                        {departments.map(d => <option key={d.id} value={d.id}>{d.department_name}</option>)}
                      </select>
                    </div>
                    <div>
                      <label style={{ display: 'block', marginBottom: 6, fontWeight: 600, fontSize: '0.875rem', color: '#374151' }}>Program *</label>
                      <select name="program_id" value={form.program_id} onChange={handleChange} required style={{ width: '100%', padding: '10px 14px', border: '2px solid #e5e7eb', borderRadius: 8, fontSize: '0.95rem', background: 'white' }}>
                        <option value="">Select Program</option>
                        {programs.map(p => <option key={p.id} value={p.id}>{p.name}</option>)}
                      </select>
                    </div>
                    <div>
                      <label style={{ display: 'block', marginBottom: 6, fontWeight: 600, fontSize: '0.875rem', color: '#374151' }}>Batch</label>
                      <select name="batch_id" value={form.batch_id} onChange={handleChange} style={{ width: '100%', padding: '10px 14px', border: '2px solid #e5e7eb', borderRadius: 8, fontSize: '0.95rem', background: 'white' }}>
                        <option value="">Select Batch</option>
                        {batches.map(b => <option key={b.id} value={b.id}>{b.name}</option>)}
                      </select>
                    </div>
                    <div>
                      <label style={{ display: 'block', marginBottom: 6, fontWeight: 600, fontSize: '0.875rem', color: '#374151' }}>From High School *</label>
                      <input name="from_high_school" value={form.from_high_school} onChange={handleChange} required style={{ width: '100%', padding: '10px 14px', border: '2px solid #e5e7eb', borderRadius: 8, fontSize: '0.95rem' }} />
                    </div>
                    <div>
                      <label style={{ display: 'block', marginBottom: 6, fontWeight: 600, fontSize: '0.875rem', color: '#374151' }}>Status</label>
                      <select name="std_status_id" value={form.std_status_id} onChange={handleChange} style={{ width: '100%', padding: '10px 14px', border: '2px solid #e5e7eb', borderRadius: 8, fontSize: '0.95rem', background: 'white' }}>
                        <option value="">Select Status</option>
                        {statuses.map(s => <option key={s.id} value={s.id}>{s.name}</option>)}
                      </select>
                    </div>
                    <div>
                      <label style={{ display: 'block', marginBottom: 6, fontWeight: 600, fontSize: '0.875rem', color: '#374151' }}>Scholarship</label>
                      <select name="schoolarship_id" value={form.schoolarship_id} onChange={handleChange} style={{ width: '100%', padding: '10px 14px', border: '2px solid #e5e7eb', borderRadius: 8, fontSize: '0.95rem', background: 'white' }}>
                        <option value="">No Scholarship</option>
                        {scholarships.map(s => <option key={s.id} value={s.id}>{s.name}</option>)}
                      </select>
                    </div>
                  </div>
                </div>

                {/* Family & Address */}
                <div style={{ marginBottom: 32 }}>
                  <h3 style={{ fontSize: '1.1rem', fontWeight: 600, color: '#1f2937', marginBottom: 16, paddingBottom: 8, borderBottom: '2px solid #4f46e5' }}>
                    üè† Family & Address Information
                  </h3>
                  <div style={{ display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: 16 }}>
                    <div>
                      <label style={{ display: 'block', marginBottom: 6, fontWeight: 600, fontSize: '0.875rem', color: '#374151' }}>Parent</label>
                      <select name="parent_id" value={form.parent_id} onChange={handleChange} style={{ width: '100%', padding: '10px 14px', border: '2px solid #e5e7eb', borderRadius: 8, fontSize: '0.95rem', background: 'white' }}>
                        <option value="">Select Parent</option>
                        {parents.map(p => <option key={p.id} value={p.id}>{p.parent_code} - {p.father_name}</option>)}
                      </select>
                    </div>
                    <div>
                      <label style={{ display: 'block', marginBottom: 6, fontWeight: 600, fontSize: '0.875rem', color: '#374151' }}>Province</label>
                      <input name="province_no" value={form.province_no} onChange={handleChange} placeholder="Province number" style={{ width: '100%', padding: '10px 14px', border: '2px solid #e5e7eb', borderRadius: 8, fontSize: '0.95rem' }} />
                    </div>
                    <div>
                      <label style={{ display: 'block', marginBottom: 6, fontWeight: 600, fontSize: '0.875rem', color: '#374151' }}>District</label>
                      <input name="district_no" value={form.district_no} onChange={handleChange} placeholder="District number" style={{ width: '100%', padding: '10px 14px', border: '2px solid #e5e7eb', borderRadius: 8, fontSize: '0.95rem' }} />
                    </div>
                    <div>
                      <label style={{ display: 'block', marginBottom: 6, fontWeight: 600, fontSize: '0.875rem', color: '#374151' }}>Commune</label>
                      <input name="commune_no" value={form.commune_no} onChange={handleChange} placeholder="Commune number" style={{ width: '100%', padding: '10px 14px', border: '2px solid #e5e7eb', borderRadius: 8, fontSize: '0.95rem' }} />
                    </div>
                    <div>
                      <label style={{ display: 'block', marginBottom: 6, fontWeight: 600, fontSize: '0.875rem', color: '#374151' }}>Village</label>
                      <input name="village_no" value={form.village_no} onChange={handleChange} placeholder="Village number" style={{ width: '100%', padding: '10px 14px', border: '2px solid #e5e7eb', borderRadius: 8, fontSize: '0.95rem' }} />
                    </div>
                  </div>
                </div>

                {/* Additional Information */}
                <div style={{ marginBottom: 20 }}>
                  <h3 style={{ fontSize: '1.1rem', fontWeight: 600, color: '#1f2937', marginBottom: 16, paddingBottom: 8, borderBottom: '2px solid #4f46e5' }}>
                    üìù Additional Information
                  </h3>
                  <div>
                    <label style={{ display: 'block', marginBottom: 6, fontWeight: 600, fontSize: '0.875rem', color: '#374151' }}>Description</label>
                    <textarea name="description" value={form.description} onChange={handleChange} rows={3} placeholder="Add any additional notes..." style={{ width: '100%', padding: '10px 14px', border: '2px solid #e5e7eb', borderRadius: 8, fontSize: '0.95rem', resize: 'vertical' }} />
                  </div>
                </div>
              </form>
            </div>

            {/* Footer */}
            <div style={{ padding: '20px 32px', borderTop: '2px solid #e5e7eb', background: '#f9fafb', display: 'flex', gap: 12, justifyContent: 'flex-end', borderRadius: '0 0 16px 16px' }}>
              <button type="button" onClick={() => setShowModal(false)} style={{ padding: '12px 24px', border: '2px solid #d1d5db', borderRadius: 8, background: 'white', cursor: 'pointer', fontWeight: 600, fontSize: '0.95rem', transition: 'all 0.2s' }} onMouseOver={(e) => e.target.style.background = '#f3f4f6'} onMouseOut={(e) => e.target.style.background = 'white'}>
                Cancel
              </button>
              <button type="submit" form="studentForm" style={{ padding: '12px 32px', border: 'none', borderRadius: 8, background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)', color: 'white', cursor: 'pointer', fontWeight: 600, fontSize: '0.95rem', boxShadow: '0 4px 12px rgba(102, 126, 234, 0.4)', transition: 'all 0.2s' }} onMouseOver={(e) => e.target.style.transform = 'translateY(-2px)'} onMouseOut={(e) => e.target.style.transform = 'translateY(0)'}>
                Create Student
              </button>
            </div>
          </div>
        </div>
      )}

      <div style={{ background: 'white', borderRadius: 12, padding: 20, boxShadow: '0 2px 8px rgba(0,0,0,.06)' }}>
        <table style={{ width: '100%', borderCollapse: 'collapse' }}>
          <thead>
            <tr style={{ borderBottom: '2px solid #e5e7eb' }}>
              <th style={{ padding: 12, textAlign: 'left', fontSize: '.8rem', fontWeight: 600, color: '#64748b', textTransform: 'uppercase' }}>ID</th>
              <th style={{ padding: 12, textAlign: 'left', fontSize: '.8rem', fontWeight: 600, color: '#64748b', textTransform: 'uppercase' }}>Code</th>
              <th style={{ padding: 12, textAlign: 'left', fontSize: '.8rem', fontWeight: 600, color: '#64748b', textTransform: 'uppercase' }}>English Name</th>
              <th style={{ padding: 12, textAlign: 'left', fontSize: '.8rem', fontWeight: 600, color: '#64748b', textTransform: 'uppercase' }}>Khmer Name</th>
              <th style={{ padding: 12, textAlign: 'left', fontSize: '.8rem', fontWeight: 600, color: '#64748b', textTransform: 'uppercase' }}>Gender</th>
              <th style={{ padding: 12, textAlign: 'left', fontSize: '.8rem', fontWeight: 600, color: '#64748b', textTransform: 'uppercase' }}>DOB</th>
              <th style={{ padding: 12, textAlign: 'left', fontSize: '.8rem', fontWeight: 600, color: '#64748b', textTransform: 'uppercase' }}>Phone</th>
            </tr>
          </thead>
          <tbody>
            {students.map(s => (
              <tr key={s.id} style={{ borderBottom: '1px solid #f3f4f6' }}>
                <td style={{ padding: 12, fontSize: '.9rem' }}>{s.id}</td>
                <td style={{ padding: 12, fontSize: '.9rem', fontWeight: 500 }}>{s.student_code}</td>
                <td style={{ padding: 12, fontSize: '.9rem' }}>{s.std_eng_name}</td>
                <td style={{ padding: 12, fontSize: '.9rem' }}>{s.std_khmer_name}</td>
                <td style={{ padding: 12, fontSize: '.9rem' }}>{s.gender === '1' ? 'Female' : 'Male'}</td>
                <td style={{ padding: 12, fontSize: '.9rem' }}>{s.dob}</td>
                <td style={{ padding: 12, fontSize: '.9rem' }}>{s.phone}</td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    </DashboardLayout>
  );
}
